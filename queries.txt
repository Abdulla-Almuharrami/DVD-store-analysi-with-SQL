/*q1 what are the top three movies with highest total amount ?*/

WITH t1
AS (SELECT
	title,
	rental_date,
	amount
FROM film
JOIN inventory
	USING (film_id)
JOIN rental
	USING (inventory_id)
JOIN payment
	USING (rental_id))

SELECT
	title,
	SUM(amount) AS total
FROM t1
GROUP BY 1
ORDER BY 2 DESC
LIMIT 3


/*q2 what is the total transaction of each staff in every month ? */

WITH u1 
AS (SELECT
 	first_name ||' '|| last_name as staff_name ,
	DATE_TRUNC('month', payment_date) AS month,
	COUNT(payment_id) OVER (PARTITION BY staff_id ORDER BY 						DATE_TRUNC('month',payment_date)) AS total_transaction_month
FROM payment 
JOIN staff 
	USING (staff_id)),
u2 
AS (SELECT
	 * , 
	row_number() over(partition by (staff_name , month) ) as row
FROM u1)

SELECT 
	staff_name,
	month,
	total_transaction_month
FROM u2
WHERE row =1 

/*q3 which genre is most demanded ?*/

SELECT
	category.name AS Genre,
	COUNT(customer.customer_id) AS renting_demand
FROM category
JOIN film_category
	USING (category_id)
JOIN film
	USING (film_id)
JOIN inventory
	USING (film_id)
JOIN rental
	USING (inventory_id)
JOIN customer
	USING (customer_id)
GROUP BY Genre
ORDER BY 2 DESC

/* q4 which country has the highest customers ? */

SELECT
	country,
	COUNT(DISTINCT customer_id) AS number_of_customers,
	SUM(amount) AS total_amount
FROM country
JOIN city
	USING (country_id)
JOIN address
	USING (city_id)
JOIN customer
	USING (address_id)
JOIN payment
	USING (customer_id)
GROUP BY country
ORDER BY total_amount DESC 









